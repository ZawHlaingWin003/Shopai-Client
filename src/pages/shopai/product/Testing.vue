<template>
    <div>
        <svg
            fill="currentcolor"
            xmlns="http://www.w3.org/2000/svg"
            width="1em"
            height="1em"
            viewBox="0 0 56 56"
            class="mr-4 h-4 w-4"
        >
            <path
                d="M 30.0391 4.6094 C 30.0391 3.5078 29.1016 2.5703 28.0001 2.5703 C 26.8985 2.5703 25.9610 3.5078 25.9610 4.6094 L 25.9610 9.5312 C 25.9610 10.6328 26.8985 11.5703 28.0001 11.5703 C 29.1016 11.5703 30.0391 10.6328 30.0391 9.5312 Z M 39.5782 13.5390 C 38.8047 14.3359 38.8047 15.6484 39.5782 16.4219 C 40.3751 17.2187 41.6642 17.2422 42.4844 16.4219 L 45.9766 12.9297 C 46.7737 12.1328 46.7737 10.8203 45.9766 10.0234 C 45.2032 9.25 43.8907 9.25 43.0938 10.0234 Z M 13.5157 16.4219 C 14.2891 17.2187 15.6016 17.2187 16.3985 16.4219 C 17.1720 15.6719 17.1720 14.3125 16.4220 13.5390 L 12.9298 10.0234 C 12.1798 9.2734 10.8438 9.25 10.0469 10.0234 C 9.2735 10.7968 9.2735 12.1328 10.0235 12.9063 Z M 28.0001 16.0468 C 21.4610 16.0468 16.0469 21.4609 16.0469 28.0000 C 16.0469 34.5390 21.4610 39.9766 28.0001 39.9766 C 34.5157 39.9766 39.9298 34.5390 39.9298 28.0000 C 39.9298 21.4609 34.5157 16.0468 28.0001 16.0468 Z M 51.3203 30.0390 C 52.4219 30.0390 53.3593 29.1016 53.3593 28.0000 C 53.3593 26.8984 52.4219 25.9609 51.3203 25.9609 L 46.4220 25.9609 C 45.3204 25.9609 44.3829 26.8984 44.3829 28.0000 C 44.3829 29.1016 45.3204 30.0390 46.4220 30.0390 Z M 4.6798 25.9609 C 3.5782 25.9609 2.6407 26.8984 2.6407 28.0000 C 2.6407 29.1016 3.5782 30.0390 4.6798 30.0390 L 9.5782 30.0390 C 10.6798 30.0390 11.6173 29.1016 11.6173 28.0000 C 11.6173 26.8984 10.6798 25.9609 9.5782 25.9609 Z M 42.4610 39.6016 C 41.6642 38.8281 40.3751 38.8281 39.5782 39.6016 C 38.8047 40.3750 38.8047 41.6875 39.5782 42.4844 L 43.0938 46.0000 C 43.8907 46.7734 45.2032 46.7500 45.9766 45.9766 C 46.7737 45.2031 46.7737 43.8906 45.9766 43.0937 Z M 10.0235 43.0703 C 9.2266 43.8437 9.2266 45.1797 10.0001 45.9531 C 10.7735 46.7266 12.1094 46.7500 12.9063 45.9766 L 16.3985 42.4844 C 17.1720 41.7109 17.1720 40.3984 16.4220 39.6016 C 15.6485 38.8281 14.3126 38.8281 13.5157 39.6016 Z M 30.0391 46.4687 C 30.0391 45.3672 29.1016 44.4297 28.0001 44.4297 C 26.8985 44.4297 25.9610 45.3672 25.9610 46.4687 L 25.9610 51.3906 C 25.9610 52.4922 26.8985 53.4297 28.0001 53.4297 C 29.1016 53.4297 30.0391 52.4922 30.0391 51.3906 Z"
            ></path>
        </svg>

        <svg
            fill="currentcolor"
            xmlns="http://www.w3.org/2000/svg"
            width="1em"
            height="1em"
            viewBox="0 0 56 56"
            class="mr-4 h-4 w-4"
        >
            <path
                d="M 31.2110 14.9453 C 31.4922 14.9453 31.6563 14.7578 31.7031 14.5000 C 32.4297 10.6094 32.4063 10.5156 36.4610 9.7187 C 36.7422 9.6719 36.9063 9.5312 36.9063 9.2500 C 36.9063 8.9453 36.7422 8.8047 36.4610 8.7578 C 32.4063 7.9375 32.4297 7.8672 31.7031 3.9765 C 31.6563 3.7187 31.4922 3.5312 31.2110 3.5312 C 30.9297 3.5312 30.7891 3.7187 30.7422 3.9765 C 29.9922 7.8672 30.0391 7.9375 25.9610 8.7578 C 25.7031 8.8047 25.5157 8.9453 25.5157 9.2500 C 25.5157 9.5312 25.7031 9.6719 25.9610 9.7187 C 30.0626 10.5156 29.9922 10.6094 30.7422 14.5000 C 30.7891 14.7578 30.9297 14.9453 31.2110 14.9453 Z M 42.4375 30.7891 C 42.8594 30.7891 43.1641 30.4844 43.2110 30.0391 C 43.9844 23.7578 44.2891 23.5703 50.6406 22.5860 C 51.1561 22.4922 51.4609 22.2578 51.4609 21.7891 C 51.4609 21.3438 51.1561 21.0625 50.7342 20.9922 C 44.3360 19.7734 43.9844 19.8203 43.2110 13.5391 C 43.1641 13.0938 42.8594 12.7891 42.4375 12.7891 C 41.9922 12.7891 41.6875 13.0938 41.6407 13.5156 C 40.8204 19.8672 40.6094 20.0781 34.1172 20.9922 C 33.6953 21.0391 33.3907 21.3438 33.3907 21.7891 C 33.3907 22.2344 33.6953 22.4922 34.1172 22.5860 C 40.6094 23.7812 40.8438 23.8047 41.6407 30.0860 C 41.6875 30.4844 41.9922 30.7891 42.4375 30.7891 Z M 24.7891 52.4688 C 33.2735 52.4688 40.0469 48.1797 43.2813 40.9609 C 43.6797 40.0938 43.6094 39.3438 43.1875 38.9453 C 42.8126 38.5938 42.1563 38.5469 41.4297 38.8047 C 39.5313 39.5547 37.3047 39.9297 34.7500 39.9297 C 24.1094 39.9297 17.3126 33.2734 17.3126 22.8906 C 17.3126 19.9375 17.8750 17.1016 18.6016 15.6485 C 19.0000 14.8281 19.0000 14.1250 18.6485 13.6797 C 18.2266 13.2109 17.4766 13.1406 16.5626 13.4922 C 9.3672 16.3281 4.5391 23.9687 4.5391 32.5469 C 4.5391 43.9609 12.9531 52.4688 24.7891 52.4688 Z"
            ></path>
        </svg>

        <svg
            fill="currentcolor"
            xmlns="http://www.w3.org/2000/svg"
            width="1em"
            height="1em"
            viewBox="0 0 56 56"
            class="mr-4 h-4 w-4"
        >
            <path
                d="M 6.0860 43.2930 L 20.7579 43.2930 L 20.1251 47.6055 L 16.9142 47.6055 C 15.8360 47.6055 14.9220 48.4961 14.9220 49.5977 C 14.9220 50.6992 15.8360 51.6133 16.9142 51.6133 L 39.0860 51.6133 C 40.1642 51.6133 41.0782 50.6992 41.0782 49.5977 C 41.0782 48.4961 40.1642 47.6055 39.0860 47.6055 L 35.8751 47.6055 L 35.2423 43.2930 L 49.9144 43.2930 C 53.9219 43.2930 55.9374 41.3711 55.9374 37.2695 L 55.9374 10.4102 C 55.9374 6.3086 53.9219 4.3867 49.9144 4.3867 L 6.0860 4.3867 C 2.0782 4.3867 .6 6.3086 .6 10.4102 L .6 37.2695 C .6 41.3711 2.0782 43.2930 6.0860 43.2930 Z M 4.8438 32.9805 C 4.1407 32.9805 3.8360 32.6992 3.8360 31.9726 L 3.8360 10.4805 C 3.8360 8.8164 4.5626 8.1602 6.1564 8.1602 L 49.8438 8.1602 C 51.4609 8.1602 52.1641 8.8164 52.1641 10.4805 L 52.1641 31.9726 C 52.1641 32.6992 51.8593 32.9805 51.1561 32.9805 Z M 28.0001 40.9727 C 26.8282 40.9727 25.8204 39.9883 25.8204 38.7930 C 25.8204 37.6446 26.8282 36.6367 28.0001 36.6367 C 29.1720 36.6367 30.1798 37.6446 30.1798 38.7930 C 30.1798 39.9883 29.1720 40.9727 28.0001 40.9727 Z"
            ></path>
        </svg>

        <organism-product-form
            :product="product"
            :errors="errors"
            :isButtonLoading="isButtonLoading"
            :isSlugLoading="isSlugLoading"
            :isSelectLoading="isSelectLoading"
            :categories="categories"
            :subCategories="subCategories"
            @addProduct="addProduct"
            @getSubCategory="getSubCategory"
            @changePreviewImages="changePreviewImages"
            @deletePreviewImage="deletePreviewImage"
            @checkSlug="checkSlug"
            :previewImages="previewImages"
        />
    </div>
</template>

<script>
import axios from "@/axios-interceptors";
import OrganismProductForm from "../../../components/organisms/OrganismProductForm.vue";
export default {
    components: { OrganismProductForm },
    data() {
        return {
            product: {
                name: "",
                slug: "",
                description: "",
                price: "",
                quantity: 0,
                discount: 0,
                category: "",
                subCategory: "",
                images: [],
            },
            previewImages: [],
            errors: null,
            isButtonLoading: false,
            isSlugLoading: false,
            isSelectLoading: false,
            categories: [],
            subCategories: [],
        };
    },
    mounted() {
        this.getCategory();
    },
    methods: {
        async checkSlug() {
            this.isSlugLoading = true;
            await axios
                .post("/api/products/check-slug", {
                    name: this.product.name,
                })
                .then((response) => {
                    this.product.slug = response.data.slug;
                    this.isSlugLoading = false;
                });
        },

        deletePreviewImage(index) {
            this.product.images.splice(index, 1);
            this.previewImages.splice(index, 1);

            console.log(this.previewImages);
        },

        changePreviewImages(e) {
            this.product.images = [];
            this.previewImages = [];
            const files = e.target.files;

            for (const file of files) {
                this.product.images.push(file);
            }

            for (const file of this.product.images) {
                const reader = new FileReader();
                reader.onload = () => {
                    this.previewImages.push(reader.result);
                };
                reader.readAsDataURL(file);
            }

            console.log("Product Images => ", this.product.images);
            console.log("Preview Images => ", this.previewImages);
        },
        async addProduct() {
            this.isButtonLoading = true;
            let data = new FormData();
            data.append("name", this.product.name);
            data.append("slug", this.product.slug);
            data.append("description", this.product.description);
            data.append("price", this.product.price);
            data.append("discount", this.product.discount);
            data.append("quantity", this.product.quantity);
            data.append("category_id", this.product.category);
            data.append("sub_category_id", this.product.subCategory);

            for (let i = 0; i < this.product.images.length; i++) {
                data.append("images[]", this.product.images[i]);
            }

            await axios
                .post("/api/products", data)
                .then((response) => {
                    console.log(response);
                    this.$router.push({ name: "products.index" });
                })
                .catch((error) => {
                    console.log(error);
                    if ((error.response.status = 422)) {
                        this.errors = error.response.data.errors;
                    }
                })
                .finally(() => {
                    this.isButtonLoading = false;
                });
        },

        async getCategory() {
            await axios.get("/api/categories").then((response) => {
                this.categories = response.data.data;
            });
        },

        async getSubCategory(category_id) {
            this.product.subCategory = "";
            this.isSelectLoading = true;
            await axios
                .get(`/api/sub_categories?category_id=${category_id}`)
                .then((response) => {
                    this.subCategories = response.data.data;
                    this.isSelectLoading = false;
                });
        },
    },
};
</script>

<style>
</style>